---
- name: Add Prometheus Helm repository
  command: helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
  become_user: yuklia
  changed_when: false

- name: Add Grafana Helm repository
  command: helm repo add grafana https://grafana.github.io/helm-charts
  become_user: yuklia
  changed_when: false

- name: Update Helm repositories
  command: helm repo update
  become_user: yuklia
  changed_when: false

- name: Create monitoring namespace
  command: kubectl create namespace monitoring
  become_user: yuklia
  changed_when: false
  ignore_errors: yes

- name: Install Prometheus stack
  command: helm install prometheus prometheus-community/kube-prometheus-stack --namespace monitoring --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.storageClassName=nfs-storage
  become_user: yuklia
  changed_when: false

- name: Wait for Prometheus to be ready
  command: kubectl wait --for=condition=ready pod -l app=prometheus -n monitoring --timeout=300s
  become_user: yuklia
  changed_when: false

- name: Create monitoring ingress
  copy:
    dest: /tmp/monitoring-ingress.yaml
    content: |
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: monitoring-ingress
        namespace: monitoring
        annotations:
          kubernetes.io/ingress.class: traefik
      spec:
        rules:
        - host: grafana.{{ ansible_default_ipv4.network }}.nip.io
          http:
            paths:
            - path: /
              pathType: Prefix
              backend:
                service:
                  name: prometheus-grafana
                  port:
                    number: 80
    mode: '0644'

- name: Apply monitoring ingress
  command: kubectl apply -f /tmp/monitoring-ingress.yaml
  become_user: yuklia
  changed_when: false
