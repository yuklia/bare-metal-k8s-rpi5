---
- name: Install MetalLB using kubectl
  command: kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.13.12/config/manifests/metallb-native.yaml
  become_user: yuklia
  changed_when: false

- name: Wait for MetalLB to be ready
  command: kubectl wait --for=condition=ready pod -l app=metallb -n metallb-system --timeout=300s
  become_user: yuklia
  changed_when: false

- name: Create MetalLB IP address pool
  copy:
    dest: /tmp/metallb-ip-pool.yaml
    content: |
      apiVersion: metallb.io/v1beta1
      kind: IPAddressPool
      metadata:
        name: first-pool
        namespace: metallb-system
      spec:
        addresses:
        - {{ metallb_ip_range }}
    mode: '0644'

- name: Apply MetalLB IP address pool
  command: kubectl apply -f /tmp/metallb-ip-pool.yaml
  become_user: yuklia
  changed_when: false

- name: Create MetalLB L2 advertisement
  copy:
    dest: /tmp/metallb-l2-advertisement.yaml
    content: |
      apiVersion: metallb.io/v1beta1
      kind: L2Advertisement
      metadata:
        name: example
        namespace: metallb-system
      spec:
        ipAddressPools:
        - first-pool
    mode: '0644'

- name: Apply MetalLB L2 advertisement
  command: kubectl apply -f /tmp/metallb-l2-advertisement.yaml
  become_user: yuklia
  changed_when: false
