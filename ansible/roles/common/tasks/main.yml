---
- name: Install essential packages
  apt:
    name:
      - curl
      - wget
      - git
      - vim
      - htop
      - iotop
      - nethogs
      - net-tools
      - dnsutils
      - ca-certificates
      - gnupg
      - lsb-release
      - software-properties-common
      - apt-transport-https
    state: present
    update_cache: yes

- name: Configure hostname
  hostname:
    name: "{{ inventory_hostname }}"

- name: Update /etc/hosts
  lineinfile:
    path: /etc/hosts
    line: "{{ ansible_default_ipv4.address }} {{ inventory_hostname }}"
    regexp: ".*{{ inventory_hostname }}"
    state: present

- name:  Disable swap immediately
  command: swapoff -a
  changed_when: false

- name: Remove swap from fstab
  lineinfile:
    path: /etc/fstab
    regexp: '^([^#].*?\sswap\s+sw\s+.*)$'
    state: absent

# Handle Raspberry Pi / Debian dphys-swapfile (common source of /var/swap)
- name: Check if dphys-swapfile config exists
  stat:
    path: /etc/dphys-swapfile
  register: dphys_conf

- name: Disable dphys-swapfile if present
  when: dphys_conf.stat.exists
  block:
    - name: Set CONF_SWAPSIZE=0
      lineinfile:
        path: /etc/dphys-swapfile
        regexp: '^CONF_SWAPSIZE='
        line: 'CONF_SWAPSIZE=0'
        create: yes
    - name: Stop & disable dphys-swapfile service
      systemd:
        name: dphys-swapfile
        state: stopped
        enabled: no
    - name: dphys swapoff (best effort)
      command: dphys-swapfile swapoff
      ignore_errors: true
    - name: dphys uninstall (best effort)
      command: dphys-swapfile uninstall
      ignore_errors: true

- name: Enable IP forwarding
  sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
    reload: yes

- name: Load overlay and br_netfilter modules
  modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - overlay
    - br_netfilter

- name: Make modules persistent
  lineinfile:
    path: /etc/modules-load.d/k8s.conf
    line: "{{ item }}"
    create: yes
  loop:
    - overlay
    - br_netfilter

- name: Configure sysctl for Kubernetes
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop:
    - { name: 'net.bridge.bridge-nf-call-iptables', value: '1' }
    - { name: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
    - { name: 'net.ipv4.ip_forward', value: '1' }

- name: Create k8s.conf sysctl file
  copy:
    dest: /etc/sysctl.d/k8s.conf
    content: |
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward = 1

- name: Set timezone
  timezone:
    name: UTC

- name: Configure NTP
  apt:
    name: ntp
    state: present

- name: Start and enable NTP service
  systemd:
    name: ntp
    state: started
    enabled: yes

- name: Create k8s user
  user:
    name: k8s
    system: yes
    shell: /bin/bash
    groups: sudo
    append: yes

- name: Set up SSH key for k8s user
  authorized_key:
    user: k8s
    state: present
    key: "{{ lookup('file', '~/.ssh/homelab-k8s-pi.pub') }}"

- name: Detect cmdline path (Ubuntu on Pi uses /boot/firmware; Debian/Raspbian often /boot)
  become: true
  stat:
    path: /boot/firmware/cmdline.txt
  register: cmdline_fw

- name: Set cmdline_path fact
  set_fact:
    cmdline_path: "{{ '/boot/firmware/cmdline.txt' if cmdline_fw.stat.exists else '/boot/cmdline.txt' }}"

# Make a safe backup file without colons (works on VFAT)
- name: Create safe backup of cmdline.txt (once)
  become: true
  copy:
    src: "{{ cmdline_path }}"
    dest: "{{ cmdline_path }}.{{ lookup('pipe','date +%Y%m%d%H%M%S') }}.bak"
    remote_src: true
    mode: '0644'
  when:
    - ansible_architecture == "aarch64"
    - ansible_os_family == "Debian"

# Only add flags if they're missing (avoid duplicates)
- name: Read current cmdline
  become: true
  slurp:
    path: "{{ cmdline_path }}"
  register: cmdline_raw
  when:
    - ansible_architecture == "aarch64"
    - ansible_os_family == "Debian"

- name: Enable cgroup memory and cpuset (append once, no module backup on VFAT)
  become: true
  lineinfile:
    path: "{{ cmdline_path }}"
    regexp: '^(.*?)(\s*)$'
    line: '\1 cgroup_enable=cpuset cgroup_enable=memory cgroup_memory=1\2'
    backrefs: yes
    backup: no
  register: cmdline_updated
  when:
    - ansible_architecture == "aarch64"
    - ansible_os_family == "Debian"
    - "'cgroup_enable=memory' not in (cmdline_raw.content | b64decode)"

# Let the operator know a reboot is needed if we changed cmdline
- name: Reboot required for cgroup flags
  debug:
    msg: "cgroup flags added to {{ cmdline_path }}. Reboot this node to apply, then start Docker."
  when: cmdline_updated is defined and cmdline_updated.changed

- name: Ensure alias 'k=kubectl' exists in yuklia's .bashrc
  lineinfile:
    path: /home/yuklia/.bashrc
    regexp: '^alias k='
    line: "alias k=kubectl"
    state: present
    create: yes
    owner: yuklia
    group: yuklia
    mode: '0644'